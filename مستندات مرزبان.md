مستندات مرزبان 
# Marzban API Documentation

## Introduction
This documentation details the REST API endpoints provided by the Marzban panel.
The API facilitates programmatic management of users, admins, nodes, and system configurations.

**Base URL**: `http://YOUR_MARZBAN_DOMAIN:8000` (Default)
**Authentication**: Bearer Token (JWT)

---

## 1. Authentication

### Get Access Token (Login)
Obtain a Bearer token to authenticate subsequent requests.
- **Endpoint**: `POST /api/admin/token`
- **Content-Type**: `application/x-www-form-urlencoded`
- **Parameters**:
    - `username` (string, required)
    - `password` (string, required)
    - `grant_type`: `password`
- **Response**: `Token` object
```json
{
  "access_token": "eyJhbGciOiJIUzI1Ni...",
  "token_type": "bearer"
}
```

---

## 2. Admin Management

### Get Current Admin
Retrieve information about the currently logged-in admin.
- **Endpoint**: `GET /api/admin`
- **Response**: `Admin` object

### Create Admin
Create a new administrator account.
- **Endpoint**: `POST /api/admin`
- **Body**: `AdminCreate`
```json
{
  "username": "newadmin",
  "password": "secretpassword",
  "is_sudo": true,
  "telegram_id": 12345678,
  "discord_webhook": "https://..."
}
```

### Modify Admin
Update an existing administrator's details.
- **Endpoint**: `PUT /api/admin/{username}`
- **Body**: `AdminModify`
- **Note**: Only fields to be updated should be included.

### Remove Admin
Delete an administrator.
- **Endpoint**: `DELETE /api/admin/{username}`

### Get All Admins
Retrieve a list of all administrators.
- **Endpoint**: `GET /api/admins`
- **Query Parameters**:
    - `offset` (int, optional): Pagination offset
    - `limit` (int, optional): Pagination limit
    - `username` (string, optional): Filter by username

### Admin Actions
- **Disable All Users**: `POST /api/admin/{username}/users/disable`
- **Activate All Users**: `POST /api/admin/{username}/users/activate`
- **Reset Usage**: `POST /api/admin/usage/reset/{username}`
- **Get Usage**: `GET /api/admin/usage/{username}`

---

## 3. User Management

### Create User
Add a new proxy user.
- **Endpoint**: `POST /api/user`
- **Body**: `UserCreate`
```json
{
  "username": "john_doe",
  "proxies": {},
  "expire": 1700000000,
  "data_limit": 10737418240,
  "data_limit_reset_strategy": "no_reset",
  "inbounds": {},
  "status": "active"
}
```

### Get User
Retrieve details of a specific user.
- **Endpoint**: `GET /api/user/{username}`

### Modify User
Update a user's settings.
- **Endpoint**: `PUT /api/user/{username}`
- **Body**: `UserModify`

### Delete User
Remove a user permanently.
- **Endpoint**: `DELETE /api/user/{username}`

### Get All Users
Retrieve a list of users with filtering and sorting options.
- **Endpoint**: `GET /api/users`
- **Query Parameters**:
    - `offset` (int, optional)
    - `limit` (int, optional)
    - `username` (string, optional): Search by username
    - `search` (string, optional): General search
    - `status` (string, optional): Filter by status (`active`, `disabled`, `limited`, `expired`, `on_hold`)
    - `sort` (string, optional)

### User Actions
- **Reset Data Usage**: `POST /api/user/{username}/reset`
- **Revoke Subscription**: `POST /api/user/{username}/revoke_sub` (Generates new UUID/Token)
- **Activate Next Plan**: `POST /api/user/{username}/active-next`
- **Set Owner**: `PUT /api/user/{username}/set-owner?admin_username={admin}`
- **Get Usage Stats**: `GET /api/user/{username}/usage` (Params: `start`, `end`)

### Bulk User Actions
- **Reset All Users Usage**: `POST /api/users/reset`
- **Get Expired Users**: `GET /api/users/expired`
- **Delete Expired Users**: `DELETE /api/users/expired`

### User Templates
- **Get Templates**: `GET /api/user_template`
- **Create Template**: `POST /api/user_template` (Body: `UserTemplateCreate`)
- **Get Template**: `GET /api/user_template/{id}`
- **Modify Template**: `PUT /api/user_template/{id}`
- **Delete Template**: `DELETE /api/user_template/{id}`

---

## 4. Node Management

### Get All Nodes
- **Endpoint**: `GET /api/nodes`

### Add Node
Add a new node to the cluster.
- **Endpoint**: `POST /api/node`
- **Body**: `NodeCreate`
```json
{
  "name": "Node 1",
  "address": "1.2.3.4",
  "port": 62050,
  "api_port": 62051,
  "usage_coefficient": 1.0
}
```

### Get/Modify/Delete Node
- **Get**: `GET /api/node/{node_id}`
- **Modify**: `PUT /api/node/{node_id}` (Body: `NodeModify`)
- **Delete**: `DELETE /api/node/{node_id}`

### Node Actions
- **Reconnect**: `POST /api/node/{node_id}/reconnect`
- **Get Settings**: `GET /api/node/settings`
- **Get Usage**: `GET /api/nodes/usage` (Params: `start`, `end`)

---

## 5. System & Core

### System Stats
Get CPU, Memory, Bandwidth, and User stats.
- **Endpoint**: `GET /api/system`

### Core Stats
Get Xray core version and status.
- **Endpoint**: `GET /api/core`

### Core Management
- **Restart Core**: `POST /api/core/restart`
- **Get Config**: `GET /api/core/config`
- **Modify Config**: `PUT /api/core/config` (Body: `CoreConfig`)

### Inbounds & Hosts
- **Get Inbounds**: `GET /api/inbounds`
- **Get Hosts**: `GET /api/hosts`
- **Modify Hosts**: `PUT /api/hosts` (Body: `HostsModel`)

---

## 6. Subscription & Public API / Client API
These endpoints are typically used by client applications or users to fetch their subscription details. Authentication is done via the subscription token, not the Bearer token.

### Get Subscription Info
- **Endpoint**: `/sub/{token}/info`
- **Method**: `GET`

### Get Subscription Usage
- **Endpoint**: `/sub/{token}/usage`
- **Method**: `GET`
- **Params**: `start`, `end`

### Get Client Configuration
Fetch the configuration file format for specific clients (e.g., Clash, V2ray).
- **Endpoint**: `/sub/{token}/{client_type}`
- **Method**: `GET`
- **Examples**:
    - `/sub/{token}/clash`
    - `/sub/{token}/v2ray`

---

## 7. Data Models

### UserStatus (Enum)
- `active`
- `disabled`
- `limited`
- `expired`
- `on_hold`

### UserTemplateCreate
- `name`: str
- `data_limit`: int (bytes)
- `expire_duration`: int (seconds)
- `username_prefix`: str
- `username_suffix`: str
- `inbounds`: Dict[tag, [protocols]]

### ProxySettings
- `id`: str (UUID)
- `flow`: str (e.g., "xtls-rprx-vision")

### NextPlanModel
Defines what happens when a user renews or expires.
- `add_remaining_traffic`: bool
- `data_limit`: int
- `expire`: int
- `fire_on_either`: bool
